// backend/server.js
// Complete Local Business Audit Tool API with all 8 services integrated
// FIXED VERSION - Context binding and data flow issues resolved

const express = require("express");
const cors = require("cors");
const { analyzeWebsite } = require("./services/websiteService");
const { analyzeCompetitors } = require("./services/competitorService");
const { analyzeKeywords } = require("./services/keywordService");
const { analyzeCitations } = require("./services/citationService");
const { analyzePageSpeed } = require("./services/pagespeedService");
const { analyzeSchema } = require("./services/schemaService");
const { analyzeReviews } = require("./services/reviewService");
// ğŸ”§ FIX 1: Import the class instance, not destructured method
const auditProcessor = require("./services/auditProcessor");

const app = express();
const PORT = 3001;

app.use(
  cors({
    origin: true,
    credentials: true,
  }),
);

app.use(express.json());

// ğŸ”§ FIX 2: Add the missing health endpoint that troubleshooter expects
app.get("/api/health", (req, res) => {
  res.json({ 
    status: "healthy", 
    timestamp: new Date().toISOString(),
    services: "all systems operational"
  });
});

app.get("/health", (req, res) => {
  res.json({ status: "OK" });
});

app.post("/api/audit", async (req, res) => {
  try {
    console.log(
      "ğŸ“ Comprehensive audit request received:",
      req.body.businessName,
    );

    const startTime = Date.now();

    // ğŸ”§ FIX 3: Ensure proper location data mapping
    const businessData = {
      ...req.body,
      // Ensure location fields are properly mapped
      city: req.body.city || '',
      state: req.body.state || '',
      // Create combined location for backward compatibility
      location: req.body.city && req.body.state 
        ? `${req.body.city}, ${req.body.state}` 
        : req.body.location || ''
    };

    console.log("ğŸ“ Business location data:", {
      city: businessData.city,
      state: businessData.state,
      location: businessData.location
    });

    // ğŸ” API Credentials - Using Codespaces Secrets (NO fallback keys for security)
    const apiCredentials = {
      // DataForSEO handles Maps/Citations/Competitors/Reviews
      username: process.env.DATAFORSEO_USER,
      password: process.env.DATAFORSEO_PASS,
      
      // OpenAI for keyword analysis
      openaiApiKey: process.env.OPENAI_API_KEY,
      
      // Google PageSpeed for performance analysis
      googleApiKey: process.env.GOOGLE_PAGESPEED_API_KEY,
      
      // Google Sheets for storing results (optional)
      googleSheetsApiKey: process.env.GOOGLE_SHEETS_API_KEY
    };

    // ğŸ”‘ Debug: Check API keys status (remove in production)
    console.log('ğŸ”‘ API Keys Status:');
    console.log('DataForSEO User:', apiCredentials.username ? 'âœ… SET' : 'âŒ MISSING');
    console.log('DataForSEO Pass:', apiCredentials.password ? 'âœ… SET' : 'âŒ MISSING');
    console.log('OpenAI:', apiCredentials.openaiApiKey ? 'âœ… SET' : 'âŒ MISSING');
    console.log('Google PageSpeed:', apiCredentials.googleApiKey ? 'âœ… SET' : 'âŒ MISSING');
    console.log('Google Sheets:', apiCredentials.googleSheetsApiKey ? 'âœ… SET' : 'âŒ MISSING');

    // ğŸ§ª Debug - Check what credentials are actually being passed to services
    console.log('ğŸ§ª Debug - Credentials being passed to services:');
    console.log('DataForSEO username exists:', !!apiCredentials.username);
    console.log('DataForSEO password exists:', !!apiCredentials.password);
    console.log('OpenAI key exists:', !!apiCredentials.openaiApiKey);
    console.log('Google PageSpeed key exists:', !!apiCredentials.googleApiKey);

    // STEP 1: Website Content Analysis
    console.log("ğŸŒ Step 1: Starting website analysis...");
    const websiteResults = await analyzeWebsite(businessData);
    console.log("âœ… Website analysis complete");

    // STEP 2: Competitor Analysis
    console.log("ğŸ† Step 2: Starting competitor analysis...");
    const competitorResults = await analyzeCompetitors(
      businessData,
      apiCredentials,
    );
    console.log("âœ… Competitor analysis complete");

    // STEP 3: Keyword Analysis
    console.log("ğŸ” Step 3: Starting keyword analysis...");
    const keywordResults = await analyzeKeywords(
      websiteResults,
      competitorResults,
      apiCredentials,
    );
    console.log("âœ… Keyword analysis complete");

    // STEP 4: Citation Analysis
    console.log("ğŸ“Š Step 4: Starting citation analysis...");
    const citationResults = await analyzeCitations(
      businessData,
      websiteResults,
      competitorResults,
      apiCredentials,
    );
    console.log("âœ… Citation analysis complete");

    // STEP 5: PageSpeed Analysis
    console.log("âš¡ Step 5: Starting PageSpeed analysis...");
    const pagespeedResults = await analyzePageSpeed(businessData, apiCredentials);
    console.log("âœ… PageSpeed analysis complete");

    // STEP 6: Schema Markup Analysis
    console.log("ğŸ—ï¸ Step 6: Starting schema analysis...");
    const schemaResults = await analyzeSchema(businessData);
    console.log("âœ… Schema analysis complete");

    // STEP 7: Review & Reputation Analysis
    console.log("ğŸŒŸ Step 7: Starting review & reputation analysis...");
    const reviewResults = await analyzeReviews(
      businessData,
      competitorResults,
      apiCredentials,
    );
    console.log("âœ… Review analysis complete");

    // STEP 8: Final Audit Processing & Report Generation
    console.log("ğŸ“‹ Step 8: Starting comprehensive audit processing...");
    
    // ğŸ”§ FIX 4: Create combined data structure for processor
    const businessDataWithResults = {
      ...businessData,
      allAnalysisResults: {
        websiteResults,
        competitorResults,
        keywordResults,
        citationResults,
        pagespeedResults,
        schemaResults,
        reviewResults,
      }
    };

    // ğŸ”§ FIX 5: Call processor as method on class instance (preserves 'this' context)
    const finalAuditResults = await auditProcessor.processAudit(businessDataWithResults);
    console.log("âœ… Comprehensive audit processing complete");

    const executionTime = Date.now() - startTime;

    // Enhanced audit results combining all services with final processing
    const auditResults = {
      // Core business information
      businessName: businessData.businessName,
      location: businessData.location,
      website: businessData.website,

      // Final processed results (primary output)
      ...finalAuditResults,

      // Raw service results for detailed analysis
      serviceResults: {
        websiteAnalysis: websiteResults,
        competitorAnalysis: competitorResults,
        keywordAnalysis: keywordResults,
        citationAnalysis: citationResults,
        pagespeedAnalysis: pagespeedResults,
        schemaAnalysis: schemaResults,
        reviewAnalysis: reviewResults,
      },

      // Enhanced audit summary
      auditSummary:
        finalAuditResults.auditSummary ||
        `${businessData.businessName} comprehensive analysis completed successfully!`,

      // Execution metadata
      generatedAt: new Date().toISOString(),
      executionTimeMs: executionTime,

      // Service completion status
      servicesCompleted: {
        websiteAnalysis: websiteResults.success !== false,
        competitorAnalysis: competitorResults.success !== false,
        keywordAnalysis: keywordResults.success !== false,
        citationAnalysis: citationResults.success !== false,
        pagespeedAnalysis: pagespeedResults.success !== false,
        schemaAnalysis: schemaResults.success !== false,
        reviewAnalysis: reviewResults.success !== false,
        finalProcessing: finalAuditResults.success !== false,
      },

      // Enhanced improvement opportunities from all services
      allImprovementOpportunities: [
        ...(websiteResults.improvementOpportunities || []),
        ...(competitorResults.businessData?.improvementOpportunities || []),
        ...(keywordResults.parsedSections?.missingServiceKeywords || []).map(
          (kw) => `Target keyword: "${kw}"`,
        ),
        ...(citationResults.recommendations || []),
        ...(pagespeedResults.recommendations || []),
        ...(schemaResults.recommendations || []),
        ...(reviewResults.recommendations || []),
      ],

      // Combined performance metrics
      performanceMetrics: {
        overallVisibilityScore: finalAuditResults.visibilityScore || 0,
        websitePerformanceScore:
          pagespeedResults.overallSummary?.averageScore || 0,
        localContentScore: websiteResults.localContentScore || 0,
        competitivePosition:
          competitorResults.businessData?.completenessLevel || "Unknown",
        reviewPerformance: {
          businessReviewCount: reviewResults.businessReviewCount || 0,
          businessRating: reviewResults.businessRating || 0,
          competitorComparison: {
            avgCompetitorReviews: reviewResults.avgCompetitorReviewCount || 0,
            avgCompetitorRating: reviewResults.avgCompetitorRating || 0,
          },
        },
        citationConsistency:
          citationResults.consistencyScores?.napConsistency || 0,
        schemaImplementation: schemaResults.score || 0,
      },
    };

    console.log(`ğŸ‰ Complete audit finished in ${executionTime}ms`);
    console.log(
      `ğŸ“Š Final visibility score: ${finalAuditResults.visibilityScore}/100`,
    );
    console.log(`ğŸ¯ Performance level: ${finalAuditResults.performanceLevel}`);
    console.log(`âš ï¸ Issues found: ${finalAuditResults.totalImprovementsCount}`);

    res.json({
      success: true,
      data: auditResults,
    });
  } catch (error) {
    console.error("âŒ Complete audit processing failed:", error);
    res.status(500).json({
      success: false,
      error: "Complete audit processing failed",
      message: error.message,
      stack: process.env.NODE_ENV === "development" ? error.stack : undefined,
    });
  }
});

// Health check for individual services
app.get("/api/health/services", (req, res) => {
  res.json({
    status: "OK",
    services: {
      websiteAnalysis: "Available",
      competitorAnalysis: "Available",
      keywordAnalysis: "Available",
      citationAnalysis: "Available",
      pagespeedAnalysis: "Available",
      schemaAnalysis: "Available",
      reviewAnalysis: "Available",
      auditProcessor: "Available",
    },
    timestamp: new Date().toISOString(),
  });
});

app.listen(PORT, () => {
  console.log(
    `ğŸš€ Local Business Audit Tool API running on http://localhost:${PORT}`,
  );
  console.log(`âœ… Complete audit pipeline ready with 8 integrated services:`);
  console.log(`   1. ğŸŒ Website Content Analysis`);
  console.log(`   2. ğŸ† Competitor Analysis & Benchmarking`);
  console.log(`   3. ğŸ” AI-Powered Keyword Analysis`);
  console.log(`   4. ğŸ“Š Citation & NAP Consistency Analysis`);
  console.log(`   5. âš¡ PageSpeed Performance Analysis`);
  console.log(`   6. ğŸ—ï¸ Schema Markup Validation`);
  console.log(`   7. ğŸŒŸ Review & Reputation Analysis`);
  console.log(`   8. ğŸ“‹ Final Audit Processing & Report Generation`);
  console.log(`ğŸ”‘ API Integrations configured:`);
  console.log(`   â€¢ DataForSEO API (Competitor, Citation, Maps & Review data)`);
  console.log(`   â€¢ OpenAI API (AI keyword analysis)`);
  console.log(`   â€¢ Google PageSpeed API (Performance metrics)`);
  console.log(`   â€¢ Google Sheets API (Results storage) - Optional`);
  console.log(`ğŸ¯ Ready to generate comprehensive local business audits!`);
});